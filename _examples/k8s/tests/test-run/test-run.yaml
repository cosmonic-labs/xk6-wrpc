apiVersion: k6.io/v1alpha1
kind: TestRun
metadata:
  name: test
spec:
  arguments: "--tag test-id=$(TEST_NAME) -o experimental-opentelemetry"
  runner:
    image: ghcr.io/cosmonic-labs/xk6-wrpc:main
    imagePullPolicy: Always
    tolerations:
      - effect: NoSchedule
        key: canon
        operator: Equal
        value: "true"
    nodeSelector:
      k6-pool: canon
    # resources:
    #   limits:
    #     cpu: "1"
    #     ephemeral-storage: 1Gi
    #     memory: 1Gi
    #   requests:
    #     cpu: "1"
    #     ephemeral-storage: 1Gi
    #     memory: 1Gi
    env:
      - name: K6_OTEL_GRPC_EXPORTER_INSECURE
        value: "true"
      - name: K6_OTEL_GRPC_EXPORTER_ENDPOINT
        value: "opentelemetry-collector-headless:4317"
      - name: K6_OTEL_METRIC_PREFIX
        value: "k6_"
      - name: GOMEMLIMIT
        valueFrom:
          resourceFieldRef:
            resource: limits.memory
      - name: GOMAXPROCS
        valueFrom:
          resourceFieldRef:
            resource: limits.cpu
      - name: TEST_NAME
        valueFrom:
          fieldRef:
            apiVersion: v1
            fieldPath: metadata.labels['k6-test']
    # affinity:
    #   podAntiAffinity:
    #     requiredDuringSchedulingIgnoredDuringExecution:
    #       - labelSelector:
    #           matchExpressions:
    #             - key: k6-stack
    #               operator: In
    #               values:
    #                 - "true"
    #         topologyKey: kubernetes.io/hostname
